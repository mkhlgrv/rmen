---
title: "Руководство пользователя"
output: rmarkdown::html_vignette
params:
  archive_name: "ml_nowcasting_2021-10-04"
  tar_gz_archive_name: "rmen_0.0.0.9000.tar.gz"
vignette: >
  %\VignetteIndexEntry{userguide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
Пакет `rmen` (Russian Macroeconomic Nowcasting) предназначен для прогнозирования в реальном времени показателей российской экономики с помощью методов машинного обучения. База данных для предсказаний создается и регулярно обновляется с помощью пакета `rmedb`. Пользователь может выбрать любой подходящий для регрессии метод машинного обучения из доступных в пакете `caret` (см. [список доступных моделей](https://topepo.github.io/caret/available-models.html)) или создать собственный метод (см. [руководство по созданию метода](https://topepo.github.io/caret/using-your-own-model-in-train.html)).

# Установка
Установите `R`, `Rstudio` и вспомогательный пакет `devtools` так, как это описано в руководстве \link[rmedb]{User Guide}.
Если `devtools` успешно установлен, скачайте архив ``r params$archive_name`` и распакуйте его.

Установите пакет `rmedb` с помощью функции `install_local` из пакета `devtools` (в R для обращения напрямую к функциям пакета используется `::`), в аргументе `path` указав путь к файлу ``r params$tar_gz_archive_name``, который находится в распакованном архиве:

```{r, eval=FALSE}
devtools::install_local(path = "C:/PATH/TO/TAR.GZ")
```

> &#9888; **Для пользователей Windows:** В R при разделении имён директорий используется <kbd>/</kbd>

Если вы устанавливаете пакет из Rstudio, вам предложат скачать или обновить пакеты, неоходимые для работы. Подтвердите обновления в соответствии с текстом на экране. 

После выполнения кода в случае успешной установки пакета вы получите в выводе консоли примерно следующие строки (возможно, вы найдете эти строки не в самом конце вывода):

```{eval=FALSE}
** building package indices
** testing if installed package can be loaded from temporary location
*** arch - i386
*** arch - x64
** testing if installed package can be loaded from final location
*** arch - i386
*** arch - x64
** testing if installed package keeps a record of temporary installation path
* DONE (rmen)
```



# Пример использования

Создание прогноза происходит в несколько шагов.
На первом шаге необходимо создать объект класса `nowcast`. Предположим, что нашей целью является предсказание реального ВВП в текущем квартале. В качестве предикторов будут использоваться индекс промышленного производства и безработица. Начнем с того, что найдем тикеры в пакете `rmedb` для используемых переменных. Используем поиск в таблице в `Rstudio`:
```{eval=FALSE}
View(rmedb::show.variables())
```
Тикеры реального ВВП, ИПП и безработицы - это `gdp_real`, `ipi`, `unemployment` соответственно. Используя найденные тикеры, создадим объект класса `nowcast` с помощью функции `new`. Для предсказаний мы будем использовать метод случайного леса (`rf` в пакете `caret`).


```{r}
library(rmen)
gdp_nowcast <- new("nowcast", # название класса, неизменно
    target = "gdp_real", # тикер целевой переменной (ВВП)
    name = "GDP Nowcast with Random Forest", # пользовательское название прогноза
    start_date = "2000-01-01", # дата, наблюдения ранее которой не будут использоваться (можно использовать только формат "YYYY-mm-dd")
    nowcast_date = Sys.Date(), # дата, относительно которой строится прогноз - сегодняшний день (в настоящий момент функционал, связанный с этим параметров, не полный, поэтому не рекомендуется изменять дефолтное значение)
    horizon = 0, # горизонт прогнозирования в единицах времени, которые соответствуют периодичности целевой переменной (для реального ВВП - кварталы). Для значения 0 происходит предсказание значения в текущем квартале, для значения 1 - в следущем квартале, и т.д.
    target_deseason = "logdiff", # способ удаления сезонности у целевой переменной. В настоящее время поддерживается три типа: level (без удаления сезонности), diff (разность к соответствующему периоду прошлого года), logdiff (разность логарифмов к соответствующему периоду прошлого года)
    predictors = , # list, состоящий из list для каждого предиктора
    list(
      list(
      ticker = "ipi",# тикер ИПП
  lag = 0, # количество используемых лагов
  deseason = "logdiff"),# способ удаления сезонности
  list(
      ticker = "unemployment", # тикер безработицы
  lag = 1, # количество используемых лагов
  deseason = "diff"# способ удаления сезонности
    )
  ),
    methods = ,# list, состоящий  из list для каждого метода
    list( # внутри list для специфического метода должно быть 4 элемента: name, train, trControl, tunegrid (подробно про содержание трех последних элементов смотрите документацию пакета caret)
      list(name="RF", # пользовательское название метода
    train=list(method ="rf", # аргументы, передаваемые в функцию train пакета caret
       tuneLength=4, 
	metric = "RMSE"),
    trControl= list("method" = "repeatedcv", # аргументы, передаваемые в функцию trControl пакета caret
    number= 2,
    repeats= 2,
    search= "random"),
    tungerid=list("mtry" = c(1,3) # аргументы, передаваемые в функцию tunegrid пакета caret
   ))
    )
    )
```

Применим к созданному объекту метод `collect.data`, который получит из базы данных пакета `rmedb` данные в соответствии с указанной спецификацией.
В результате в созданном объекте появятся три новых элемента: `X`, `y`и `dates` (обратиться к ним можно через \@). Посмотрим на собранные данные.
```{r}
gdp_nowcast <- collect.data(gdp_nowcast)
print(head(gdp_nowcast@X))
print(head(gdp_nowcast@y))
print(head(gdp_nowcast@dates))
```
Убедившись, что данные успешно собраны, применим метод `fit` для обучения модели случайного леса.
```{r}
gdp_nowcast <-fit(gdp_nowcast)
```

Посмотрим на обученную модель:
```{r}
print(gdp_nowcast@fit)
```
Посмотрим на полученное предсказание (не удивительно, что предсказание выглядит достаточно неадекватно, так как мы использовали неподходящий набор параметров для обучения модели в целях ускорения):
```{r}
gdp_nowcast@pred
```
# Рекомендации по использованию моделей
Позднее здесь появится информация о том, как задавать параметры для моделей, а также о том, как это делать без использования `R`, с помощью графического интерфейса и интуитивного описания параметров.
